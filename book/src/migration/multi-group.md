# 从单 Group 迁移到多 Group（Multi-Group）

<aside class="note warning">

<h1>注意</h1>

Kubebuilder 默认不会为“同一仓库支持多个 API 组”的结构进行脚手架，但你可以通过调整项目结构来支持多 Group。

核心思路是：按 API 组名为维度，分别移动对应的 API 与 Controller 到以组名命名的新目录下。

</aside>

下面以 [CronJob 示例][cronjob-tutorial] 进行迁移演示。

<aside class="note warning">
<h1>不同布局的指引差异</h1>

可在 `PROJECT` 文件查看当前项目布局版本。当前默认且推荐的版本为 `go/v4`。

`go/v3` 已被标记为弃用，若仍在使用，建议先迁移到 `go/v4`。本页说明仍对 `go/v3` 有参考价值，见[从 go/v3 迁移到 go/v4][migration-guide]。

</aside>

将项目切换为多 Group 布局：
运行 `kubebuilder edit --multigroup=true`。切换后，新建的 Kind 会按多 Group 布局生成；但已有的 API 组需手动迁移到新布局。

通常我们以 API 组前缀作为目录名。可查看 `api/v1/groupversion_info.go` 获取组名：

```go
// +groupName=batch.tutorial.kubebuilder.io
package v1
```

然后，将现有 API 移动到以组名命名的子目录下。以 [CronJob 示例][cronjob-tutorial] 为例，子目录为 "batch"：

```bash
mkdir api/batch
mv api/* api/batch
```

API 移动后，Controller 也需按相同规则迁移（以 go/v4 为例）：

```bash
mkdir internal/controller/batch
mv internal/controller/* internal/controller/batch/
```

已有的 [Webhook][webhooks] 亦需同样处理：
```bash
mkdir internal/webhook/batch
mv internal/webhook/* internal/webhook/batch/
```
后续为新组创建的 Webhook，会生成在 `internal/webhook/<group>/` 下。

<aside class="note">
<h1>若使用已弃用的 go/v3 布局</h1>
该布局没有 `internal` 目录，因此需将控制器移动到以 API 组命名的一级目录下：

```bash
mkdir controller/batch
mv controller/* controller/batch/
```

</aside>

接着，更新对旧包路径的所有引用。以 CronJob 为例，需调整 `main.go` 与 `controllers/batch/cronjob_controller.go` 中的导入路径，指向新结构下的位置。

如果项目中还有其它自定义文件，也需要同步修正导入路径。

最后手动修正 `PROJECT` 文件。`kubebuilder edit --multigroup=true` 仅开启多 Group，不会修复已存在 API 的 `path`。需要为每个资源更新其路径。

例如，原文件：

```yaml
# Code generated by tool. DO NOT EDIT.
# This file is used to track the info used to scaffold your project
# and allow the plugins properly work.
# More info: https://book.kubebuilder.io/reference/project-config.html
domain: tutorial.kubebuilder.io
layout:
- go.kubebuilder.io/v4
multigroup: true
projectName: test
repo: tutorial.kubebuilder.io/project
resources:
- api:
    crdVersion: v1
    namespaced: true
  controller: true
  domain: tutorial.kubebuilder.io
  group: batch
  kind: CronJob
  path: tutorial.kubebuilder.io/project/api/v1beta1
  version: v1beta1
version: "3"
```

需将 `path: tutorial.kubebuilder.io/project/api/v1beta1` 替换为
`path: tutorial.kubebuilder.io/project/api/batch/v1beta1`。

对于非新建项目，已实现的旧 API 也需按需调整。
注意在多 Group 布局下，Kind 的 API 文件位置为 `api/<group>/<version>`（而非 `api/<version>`）；控制器位置为 `internal/controller/<group>`（而非 `internal/controller`）。

这就是我们需要把既有 API/Controller 移动到新结构对应位置的原因。别忘了同步更新导入路径。

为使 envtest 能正确安装 CRD 到测试环境，需要在每个 `internal/controller/<group>/suite_test.go` 中更新 CRD 目录的相对路径，多加一层 `".."`，例如：

```go
    By("bootstrapping test environment")
    testEnv = &envtest.Environment{
        CRDDirectoryPaths: []string{filepath.Join("..", "..", "config", "crd", "bases")},
    }
```

[CronJob 教程][cronjob-tutorial]对上述变更有更详细的说明（针对单 Group 项目的自动生成情况）。

[multi-group-issue]: https://github.com/kubernetes-sigs/kubebuilder/issues/923 "Kubebuilder Issue #923"
[cronjob-tutorial]: /cronjob-tutorial/cronjob-tutorial.md "Tutorial: Building CronJob"
[migration-guide]: /migration/migration_guide_gov3_to_gov4.md "Migration from go/v3 to go/v4"
[webhooks]: /cronjob-tutorial/webhook-implementation.md "Implementing defaulting/validating webhooks"
